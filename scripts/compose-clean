#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# ------------------------------------------------------------------------------
# compose-clean
#
# Purpose:
#   Run Docker Compose with a sanitized environment so that host shell exports
#   (e.g. MILVUS_URI, DB_URL, etc.) cannot override values from `.env`.
#
# Usage:
#   ./scripts/compose-clean ps
#   ./scripts/compose-clean up -d --build
# ------------------------------------------------------------------------------

# Resolve project root (assuming script is in scripts/ directory)
script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
project_root="$(dirname "$script_dir")"
cd "$project_root"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  cat <<'EOF'
compose-clean: run docker compose with a sanitized env

Examples:
  ./scripts/compose-clean ps
  ./scripts/compose-clean up -d --build
  ./scripts/compose-clean logs -f --tail=200 backend
  
  # For different deployment modes, use -f flag:
  ./scripts/compose-clean -f docker-compose-no-local-embedding.yml up -d --build
  ./scripts/compose-clean -f docker-compose.gpu.yml up -d --build

Notes:
  - Runs from repo root.
  - Always uses: --env-file .env
  - Preserves only "safe" host vars.
EOF
  exit 0
fi

if [[ ! -f .env ]]; then
  echo "❌ .env not found in repo root: $project_root" >&2
  echo "   Create it from template: cp .env.template .env" >&2
  exit 1
fi

compose_cmd=()
if docker compose version >/dev/null 2>&1; then
  compose_cmd=(docker compose)
elif command -v docker-compose >/dev/null 2>&1; then
  compose_cmd=(docker-compose)
else
  echo "❌ Docker Compose not found (tried: 'docker compose' and 'docker-compose')." >&2
  exit 1
fi

# Build a minimal allowlist for the host environment.
env_cmd=(env -i "PATH=${PATH}")

allow_vars=(
  HOME USER LOGNAME SHELL TERM LANG LC_ALL LC_CTYPE TZ
  DOCKER_HOST DOCKER_CONTEXT DOCKER_CONFIG DOCKER_TLS_VERIFY DOCKER_CERT_PATH
  SSH_AUTH_SOCK XDG_RUNTIME_DIR
  HTTP_PROXY HTTPS_PROXY NO_PROXY http_proxy https_proxy no_proxy
)

for var in "${allow_vars[@]}"; do
  if [[ -n "${!var-}" ]]; then
    env_cmd+=("${var}=${!var}")
  fi
done

exec "${env_cmd[@]}" "${compose_cmd[@]}" --env-file .env "$@"