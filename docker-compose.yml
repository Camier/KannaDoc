services:
  # --- 基础设施服务 ---
  kafka-init:
    container_name: layra-kafka-init
    build:
      context: ./init-kafka
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_TOPIC=${KAFKA_TOPIC}
      - KAFKA_PARTITIONS_NUMBER=${KAFKA_PARTITIONS_NUMBER}
      - KAFKA_REPLICATION_FACTOR=${KAFKA_REPLICATION_FACTOR:-1}
    networks:
      - layra-net

  kafka:
    container_name: layra-kafka
    image: apache/kafka:3.8.0
    environment:
      - KAFKA_NODE_ID=0
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://kafka:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_MIN_INSYNC_REPLICAS=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_MAX_MESSAGE_SIZE=2097152000
      - KAFKA_MESSAGE_MAX_BYTES=2097152000
      - KAFKA_NUM_PARTITIONS=${KAFKA_PARTITIONS_NUMBER:-10}
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "sh", "-c", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 30s

  minio:
    container_name: layra-minio
    image: minio/minio:RELEASE.2024-10-13T13-34-11Z
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    command: server /data --console-address ":9001"
    # Local thesis dev: expose MinIO for browser-accessible presigned URLs.
    # Host port 9080 maps to container port 9000 (system minio uses 9000)
    ports:
      - "127.0.0.1:9080:9000"
      - "127.0.0.1:9081:9001"
    volumes:
      - minio_data:/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10

  mongodb:
    container_name: layra-mongodb
    image: mongo:7.0.12
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    container_name: layra-redis
    image: redis:7.2.5
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"${REDIS_PASSWORD}\" ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 5

  mysql:
    container_name: layra-mysql
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-layra}
      - MYSQL_USER=${MYSQL_USER:-layra}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-layra}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - layra-net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p\"$MYSQL_ROOT_PASSWORD\""]
      interval: 10s
      timeout: 5s
      retries: 10



  # --- 应用服务 ---
  python-sandbox:
    container_name: layra-python-sandbox
    build:
      context: ./sandbox
    image: python-sandbox
    volumes:
      - layra_sandbox_volume:/shared
    networks:
      - layra-net

  model-weights-init:
    container_name: layra-model-weights-init
    build:
      context: ./init-db
      dockerfile: Dockerfile
    volumes:
      - model_weights:/model_weights
    environment:
      - MODEL_BASE_URL=${MODEL_BASE_URL}
    networks:
      - layra-net
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  unoserver:
    container_name: layra-unoserver
    build:
      context: ./unoserver
    environment:
      - UNOSERVER_INSTANCES=${UNOSERVER_INSTANCES:-1}
      - BASE_PORT=${UNOSERVER_BASE_PORT}
      - BASE_UNO_PORT=${UNOSERVER_BASE_UNO_PORT}
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2003"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
      
  cliproxyapi:
    container_name: layra-cliproxyapi
    image: eceasy/cli-proxy-api:latest
    ports:
      - "8085:8085"
      - "8317:8317"
    volumes:
      - ${HOME}/.cli-proxy-api/config.yaml:/CLIProxyAPI/config.yaml:ro
      - cliproxyapi_auth:/root/.cli-proxy-api
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8317/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  backend:
    container_name: layra-backend
    build:
      context: ./backend
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy

      model-server:
        condition: service_healthy
      unoserver:
        condition: service_healthy
      model-weights-init:
        condition: service_completed_successfully
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - layra_sandbox_volume:${SANDBOX_SHARED_VOLUME}
      - mysql_migrations:/app/migrations_previous
      - ./backend:/app
    environment:
      - MAX_WORKERS=${MAX_WORKERS}
      - LOG_LEVEL=${LOG_LEVEL}
      - DB_URL=${DB_URL}
      - DB_POOL_SIZE=${DB_POOL_SIZE}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW}
      - REDIS_URL=${REDIS_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_TOKEN_DB=${REDIS_TOKEN_DB}
      - REDIS_TASK_DB=${REDIS_TASK_DB}
      - REDIS_LOCK_DB=${REDIS_LOCK_DB}
      - MONGODB_URL=${MONGODB_URL}
      - MONGODB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_DB=${MONGODB_DB}
      - MONGODB_POOL_SIZE=${MONGODB_POOL_SIZE}
      - MONGODB_MIN_POOL_SIZE=${MONGODB_MIN_POOL_SIZE}
      - KAFKA_BROKER_URL=${KAFKA_BROKER_URL}
      - KAFKA_TOPIC=${KAFKA_TOPIC}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_ID}
      - MINIO_URL=${MINIO_URL}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL}
      - MINIO_PUBLIC_PORT=${MINIO_PUBLIC_PORT:-9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - MODEL_SERVER_URL=${MODEL_SERVER_URL:-http://model-server:8005}
      - DEBUG_MODE=${DEBUG_MODE}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      # Thesis deployment uses the host Milvus (holds the 3.56M patch vectors).
      # Default keeps local/dev compose working when MILVUS_URI isn't provided.
      - MILVUS_URI=${MILVUS_URI:-http://host.docker.internal:19530}
      - QDRANT_URL=http://qdrant:6333
      - VECTOR_DB=${VECTOR_DB:-milvus}
      - KAFKA_RETRY_BACKOFF_MS=${KAFKA_RETRY_BACKOFF_MS:-5000}
      - KAFKA_SESSION_TIMEOUT_MS=${KAFKA_SESSION_TIMEOUT_MS:-30000}
      - COLBERT_MODEL_PATH=${COLBERT_MODEL_PATH}
      - SANDBOX_SHARED_VOLUME=${SANDBOX_SHARED_VOLUME}
      - SERVER_IP=${SERVER_IP}
      - UNOSERVER_INSTANCES=${UNOSERVER_INSTANCES}
      - UNOSERVER_HOST=${UNOSERVER_HOST}
      - UNOSERVER_BASE_PORT=${UNOSERVER_BASE_PORT}
      - EMBEDDING_IMAGE_DPI=${EMBEDDING_IMAGE_DPI}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - JINA_API_KEY=${JINA_API_KEY}
      - JINA_EMBEDDINGS_V4_URL=${JINA_EMBEDDINGS_V4_URL}
      # RAG Tuning (optional - defaults in config.py)
      - RAG_MAX_QUERY_VECS=${RAG_MAX_QUERY_VECS:-48}
      - RAG_SEARCH_LIMIT_CAP=${RAG_SEARCH_LIMIT_CAP:-120}
      - RAG_CANDIDATE_IMAGES_CAP=${RAG_CANDIDATE_IMAGES_CAP:-120}
      - RAG_SEARCH_LIMIT_MIN=${RAG_SEARCH_LIMIT_MIN:-50}
      - RAG_EF_MIN=${RAG_EF_MIN:-100}
      - RAG_LOAD_COLLECTION_ONCE=${RAG_LOAD_COLLECTION_ONCE:-true}
      # Thesis retrieval mode (sparse recall -> ColPali rerank, optionally fused with dense recall)
      - RAG_RETRIEVAL_MODE=${RAG_RETRIEVAL_MODE:-dense}
      - RAG_PAGES_SPARSE_SUFFIX=${RAG_PAGES_SPARSE_SUFFIX:-_pages_sparse}
      - RAG_DEFAULT_TOP_K=${RAG_DEFAULT_TOP_K:-50}
      - RAG_TOP_K_CAP=${RAG_TOP_K_CAP:-120}
      - RAG_DIVERSE_FILE_LIMIT=${RAG_DIVERSE_FILE_LIMIT:-20}
      - RAG_DIVERSE_PAGES_PER_FILE_CAP=${RAG_DIVERSE_PAGES_PER_FILE_CAP:-3}
      - RAG_FALLBACK_TEXT_CAP=${RAG_FALLBACK_TEXT_CAP:-20}
      # Hybrid Search Configuration
      - RAG_HYBRID_ENABLED=${RAG_HYBRID_ENABLED:-false}
      - RAG_HYBRID_RANKER=${RAG_HYBRID_RANKER:-rrf}
      - RAG_HYBRID_RRF_K=${RAG_HYBRID_RRF_K:-60}
      - RAG_HYBRID_DENSE_WEIGHT=${RAG_HYBRID_DENSE_WEIGHT:-0.7}
      - RAG_HYBRID_SPARSE_WEIGHT=${RAG_HYBRID_SPARSE_WEIGHT:-0.3}
      # LLM Provider Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ZAI_API_KEY=${ZAI_API_KEY:-}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY}
      - MINIMAX_API_KEY=${MINIMAX_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_CLOUD_API_KEY=${OLLAMA_CLOUD_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - CLIPROXYAPI_BASE_URL=${CLIPROXYAPI_BASE_URL:-}
      - CLIPROXYAPI_API_KEY=${CLIPROXYAPI_API_KEY:-}
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-openai}
      - DEFAULT_LLM_MODEL=${DEFAULT_LLM_MODEL:-gpt-4o-mini}
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/check"]
      interval: 30s
      start_period: 10s
      timeout: 5s
      retries: 10

  model-server:
    container_name: layra-model-server
    build:
      context: ./model-server
    depends_on:
      model-weights-init:
        condition: service_completed_successfully
    volumes:
      - model_weights:/model_weights
    environment:
      - TRANSFORMERS_OFFLINE=1
      - COLBERT_MODEL_PATH=${COLBERT_MODEL_PATH}
      - CUDA_VISIBLE_DEVICES=0
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,garbage_collection_threshold:0.9,max_split_size_mb:32
      - PYTORCH_NO_CUDA_MEMORY_CACHING=1
      - PYTORCH_CUDA_MEMORY_FRACTION=0.9
      - TOKENIZERS_PARALLELISM=false
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - HF_TOKEN=${HF_TOKEN:-}
      - HUGGINGFACE_HUB_CACHE=/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    shm_size: 8gb
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health/ready"]
      interval: 30s
      start_period: 120s
      timeout: 10s
      retries: 15

  frontend:
    container_name: layra-frontend
    build:
      context: ./frontend
      args:
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
        - MINIO_IMAGE_URL_PREFIX=${MINIO_IMAGE_URL_PREFIX}
        - MINIO_URL=${MINIO_URL}
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - NODE_ENV=${NODE_ENV}
    networks:
      - layra-net

  nginx:
    container_name: layra-nginx
    image: nginx:alpine
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_healthy
    ports:
      - "8090:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - layra-net

  prometheus:
    image: prom/prometheus:v3.5.1
    container_name: layra-prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/alerts.yml:/etc/prometheus/alerts.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - layra-net
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:12.3.2
    container_name: layra-grafana
    depends_on:
      - prometheus
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    networks:
      - layra-net

networks:
  layra-net:
    external: true

volumes:
  kafka_data:
  minio_data:
  redis_data:
  mysql_data:
  mongo_data:
  milvus_etcd:
  milvus_minio:
  milvus_data:

  model_weights:
  layra_sandbox_volume:
  mysql_migrations:
  prometheus_data:
  grafana_data:
  cliproxyapi_auth:
