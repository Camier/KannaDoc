# LAYRA SOLO THESIS DEPLOYMENT
# GPU Mode + Neo4j + Simple Auth
# Optimized for single-user thesis/demonstration deployment

volumes:
  kafka_data:
  minio_data:
  redis_data:
  mysql_data:
  mongo_data:
  milvus_etcd:
  milvus_minio:
  milvus_data:
  model_weights:
  layra_sandbox_volume:
  neo4j_data:
  neo4j_logs:

services:
  # --- NEO4J GRAPH DATABASE ---
  neo4j:
    container_name: layra-neo4j
    hostname: neo4j
    image: neo4j:5.23-community
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      - NEO4J_dbms_connector_bolt_advertised__address=:7687
      - NEO4J_dbms_connector_bolt_listen__address=:7687
      - NEO4J_dbms_connector_http_advertised__address=:7474
      - NEO4J_dbms_connector_http_listen__address=:7474
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    ports:
      - "7474:7474"  # HTTP (Neo4j Browser)
      - "7687:7687"  # Bolt Protocol
    networks:
      - layra-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- INFRASTRUCTURE (simplified for solo) ---
  kafka-init:
    container_name: layra-kafka-init
    build:
      context: ./init-kafka
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_TOPIC=${KAFKA_TOPIC:-task_generation}
      - KAFKA_PARTITIONS_NUMBER=3  # Reduced for solo
      - KAFKA_REPLICATION_FACTOR=1
    networks:
      - layra-net

  kafka:
    container_name: layra-kafka
    image: apache/kafka:3.8.0
    environment:
      - KAFKA_NODE_ID=0
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://kafka:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_NUM_PARTITIONS=3
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "sh", "-c", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  minio:
    container_name: layra-minio
    image: minio/minio:RELEASE.2024-10-13T13-34-11Z
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    container_name: layra-mongodb
    image: mongo:7.0.12
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    container_name: layra-redis
    image: redis:7.2.5
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"${REDIS_PASSWORD}\" ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 5

  mysql:
    container_name: layra-mysql
    image: mysql:9.0.1
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-layra_db}
      - MYSQL_USER=${MYSQL_USER:-thesis}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10

  # --- MILVUS VECTOR DATABASE ---
  milvus-etcd:
    container_name: layra-milvus-etcd
    image: quay.io/coreos/etcd:v3.5.18
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - milvus_etcd:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  milvus-minio:
    container_name: layra-milvus-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: minio server /minio_data --console-address ":9001"
    volumes:
      - milvus_minio:/minio_data
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  milvus-standalone:
    container_name: layra-milvus-standalone
    image: milvusdb/milvus:v2.5.6
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      - ETCD_ENDPOINTS=milvus-etcd:2379
      - MINIO_ADDRESS=milvus-minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    depends_on:
      milvus-etcd:
        condition: service_healthy
      milvus-minio:
        condition: service_healthy
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 10s
      start_period: 30s
      timeout: 5s
      retries: 20

  # --- APPLICATION SERVICES ---
  python-sandbox:
    container_name: layra-python-sandbox
    build:
      context: ./sandbox
    image: python-sandbox
    volumes:
      - layra_sandbox_volume:/shared
    networks:
      - layra-net

  model-weights-init:
    container_name: layra-model-weights-init
    build:
      context: ./init-db
      dockerfile: Dockerfile
    volumes:
      - model_weights:/model_weights
    environment:
      - MODEL_BASE_URL=${MODEL_BASE_URL}
    networks:
      - layra-net
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  unoserver:
    container_name: layra-unoserver
    build:
      context: ./unoserver
    environment:
      - UNOSERVER_INSTANCES=1  # Solo: single instance
      - BASE_PORT=2003
      - BASE_UNO_PORT=3003
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2003"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  backend:
    container_name: layra-backend
    build:
      context: ./backend
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
      milvus-standalone:
        condition: service_healthy
      model-server:
        condition: service_healthy
      unoserver:
        condition: service_healthy
      model-weights-init:
        condition: service_completed_successfully
      neo4j:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - layra_sandbox_volume:${SANDBOX_SHARED_VOLUME}
    environment:
      # Solo/Thesis optimized
      - MAX_WORKERS=4
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Database Connection
      - DB_URL=mysql+asyncmy://thesis:${MYSQL_PASSWORD}@mysql:3306/layra_db
      - DB_POOL_SIZE=10
      - DB_MAX_OVERFLOW=20
      # Redis
      - REDIS_URL=${REDIS_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_TOKEN_DB=0
      - REDIS_TASK_DB=1
      - REDIS_LOCK_DB=2
      # MongoDB
      - MONGODB_URL=${MONGODB_URL}
      - MONGODB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_DB=${MONGODB_DB}
      # Kafka
      - KAFKA_BROKER_URL=${KAFKA_BROKER_URL}
      - KAFKA_TOPIC=${KAFKA_TOPIC}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_ID}
      # MinIO
      - MINIO_URL=${MINIO_URL}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      # Milvus
      - MILVUS_URI=http://milvus-standalone:19530
      # Model Server
      - COLBERT_MODEL_PATH=${COLBERT_MODEL_PATH}
      # Sandbox
      - SANDBOX_SHARED_VOLUME=${SANDBOX_SHARED_VOLUME}
      # Server Config
      - SERVER_IP=${SERVER_IP}
      # Document Processing
      - UNOSERVER_HOST=unoserver
      - UNOSERVER_BASE_PORTS=2003
      - EMBEDDING_IMAGE_DPI=${EMBEDDING_IMAGE_DPI:-200}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      # Neo4j connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      # Simple Auth for solo thesis
      - SIMPLE_AUTH_MODE=true
      - SIMPLE_API_KEY=${SIMPLE_API_KEY}
      - SIMPLE_USERNAME=${SIMPLE_USERNAME}
      - SIMPLE_PASSWORD=${SIMPLE_PASSWORD}
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/check"]
      interval: 30s
      start_period: 10s
      timeout: 5s
      retries: 10

  model-server:
    container_name: layra-model-server
    build:
      context: ./model-server
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      model-weights-init:
        condition: service_completed_successfully
    volumes:
      - model_weights:/model_weights
    environment:
      - COLBERT_MODEL_PATH=${COLBERT_MODEL_PATH}
      - CUDA_VISIBLE_DEVICES=0
    networks:
      - layra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/healthy-check"]
      interval: 30s
      start_period: 60s
      timeout: 5s
      retries: 10

  frontend:
    container_name: layra-frontend
    build:
      context: ./frontend
      args:
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
        - MINIO_IMAGE_URL_PREFIX=${MINIO_IMAGE_URL_PREFIX}
        - MINIO_URL=${MINIO_URL}
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - NODE_ENV=production
    networks:
      - layra-net

  nginx:
    container_name: layra-nginx
    image: nginx:alpine
    depends_on:
      - frontend
      - backend
    ports:
      - "8090:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - layra-net

networks:
  layra-net:
    driver: bridge
