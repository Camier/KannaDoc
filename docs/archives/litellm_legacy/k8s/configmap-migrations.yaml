apiVersion: v1
kind: ConfigMap
metadata:
  name: litellm-migrations
data:
  001_create_audit_tables.down.sql: |-
    -- ============================================================================
    -- Rollback: Drop Audit Tables for Deleted Teams and API Keys
    -- ============================================================================
    -- Description: Removes the soft-delete audit tables
    --
    -- WARNING: This will permanently delete all audit records. Consider archiving
    --          data before running this rollback if compliance requires retention.
    --
    -- Author: Database Migration System
    -- Date: 2026-01-21
    -- ============================================================================
    
    -- Drop indexes first (they will be dropped with table, but being explicit)
    DROP INDEX IF EXISTS idx_deleted_team_team_id;
    DROP INDEX IF EXISTS idx_deleted_team_deleted_at;
    DROP INDEX IF EXISTS idx_deleted_team_organization_id;
    DROP INDEX IF EXISTS idx_deleted_team_team_alias;
    DROP INDEX IF EXISTS idx_deleted_team_created_at;
    
    DROP INDEX IF EXISTS idx_deleted_token_token;
    DROP INDEX IF EXISTS idx_deleted_token_deleted_at;
    DROP INDEX IF EXISTS idx_deleted_token_user_id;
    DROP INDEX IF EXISTS idx_deleted_token_team_id;
    DROP INDEX IF EXISTS idx_deleted_token_organization_id;
    DROP INDEX IF EXISTS idx_deleted_token_key_alias;
    DROP INDEX IF EXISTS idx_deleted_token_created_at;
    
    -- Drop the audit tables
    DROP TABLE IF EXISTS "LiteLLM_DeletedTeamTable" CASCADE;
    DROP TABLE IF EXISTS "LiteLLM_DeletedVerificationToken" CASCADE;
    
    -- ============================================================================
    -- Rollback Complete
    -- ============================================================================
  001_create_audit_tables.up.sql: |-
    -- ============================================================================
    -- Migration: Create Audit Tables for Deleted Teams and API Keys
    -- ============================================================================
    -- Description: Creates soft-delete audit tables to preserve historical data
    --              for deleted teams and verification tokens (API keys)
    --
    -- Tables Created:
    --   - LiteLLM_DeletedTeamTable          (tracks deleted teams)
    --   - LiteLLM_DeletedVerificationToken  (tracks deleted API keys)
    --
    -- Author: Database Migration System
    -- Date: 2026-01-21
    -- ============================================================================
    
    -- ----------------------------------------------------------------------------
    -- Table: LiteLLM_DeletedTeamTable
    -- Purpose: Audit log for deleted teams - preserves spend and team information
    --          for historical tracking and compliance
    -- ----------------------------------------------------------------------------
    CREATE TABLE "LiteLLM_DeletedTeamTable" (
        -- Primary key - internal audit record ID
        id TEXT NOT NULL PRIMARY KEY,
    
        -- Original team identifier
        team_id TEXT NOT NULL,
    
        -- Team core fields
        team_alias TEXT,
        organization_id TEXT,
        object_permission_id TEXT,
        admins TEXT[],
        members TEXT[],
        members_with_roles JSONB NOT NULL DEFAULT '{}',
        metadata JSONB NOT NULL DEFAULT '{}',
    
        -- Budget and spend tracking
        max_budget DOUBLE PRECISION,
        spend DOUBLE PRECISION NOT NULL DEFAULT 0.0,
        model_spend JSONB NOT NULL DEFAULT '{}',
        model_max_budget JSONB NOT NULL DEFAULT '{}',
    
        -- Models and configuration
        models TEXT[],
        max_parallel_requests INTEGER,
        tpm_limit BIGINT,
        rpm_limit BIGINT,
        budget_duration TEXT,
        budget_reset_at TIMESTAMP(3) WITHOUT TIME ZONE,
    
        -- Status and permissions
        blocked BOOLEAN NOT NULL DEFAULT FALSE,
        team_member_permissions TEXT[] DEFAULT ARRAY[]::TEXT[],
        router_settings JSONB DEFAULT '{}',
    
        -- Model alias reference
        model_id INTEGER,
    
        -- Original timestamps from team creation/updates
        created_at TIMESTAMP(3) WITHOUT TIME ZONE,
        updated_at TIMESTAMP(3) WITHOUT TIME ZONE,
    
        -- Deletion metadata
        deleted_at TIMESTAMP(3) WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        deleted_by TEXT,
        deleted_by_api_key TEXT,
        litellm_changed_by TEXT
    );
    
    -- Create indexes for DeletedTeamTable
    CREATE INDEX idx_deleted_team_team_id ON "LiteLLM_DeletedTeamTable"(team_id);
    CREATE INDEX idx_deleted_team_deleted_at ON "LiteLLM_DeletedTeamTable"(deleted_at);
    CREATE INDEX idx_deleted_team_organization_id ON "LiteLLM_DeletedTeamTable"(organization_id);
    CREATE INDEX idx_deleted_team_team_alias ON "LiteLLM_DeletedTeamTable"(team_alias);
    CREATE INDEX idx_deleted_team_created_at ON "LiteLLM_DeletedTeamTable"(created_at);
    
    -- Add comment to table
    COMMENT ON TABLE "LiteLLM_DeletedTeamTable" IS 'Audit table for deleted teams - preserves spend and team information for historical tracking and compliance';
    
    -- ----------------------------------------------------------------------------
    -- Table: LiteLLM_DeletedVerificationToken
    -- Purpose: Audit log for deleted API keys - preserves spend and key information
    --          for historical tracking and compliance
    -- ----------------------------------------------------------------------------
    CREATE TABLE "LiteLLM_DeletedVerificationToken" (
        -- Primary key - internal audit record ID
        id TEXT NOT NULL PRIMARY KEY,
    
        -- Original token identifier (hashed)
        token TEXT NOT NULL,
    
        -- Key identification
        key_name TEXT,
        key_alias TEXT,
    
        -- Budget and state
        soft_budget_cooldown BOOLEAN NOT NULL DEFAULT FALSE,
        spend DOUBLE PRECISION NOT NULL DEFAULT 0.0,
        expires TIMESTAMP(3) WITHOUT TIME ZONE,
    
        -- Models and configuration
        models TEXT[],
        aliases JSONB NOT NULL DEFAULT '{}',
        config JSONB NOT NULL DEFAULT '{}',
        router_settings JSONB DEFAULT '{}',
    
        -- Ownership
        user_id TEXT,
        team_id TEXT,
        organization_id TEXT,
    
        -- Permissions and metadata
        permissions JSONB NOT NULL DEFAULT '{}',
        metadata JSONB NOT NULL DEFAULT '{}',
        allowed_cache_controls TEXT[] DEFAULT ARRAY[]::TEXT[],
        allowed_routes TEXT[] DEFAULT ARRAY[]::TEXT[],
    
        -- Limits
        max_parallel_requests INTEGER,
        tpm_limit BIGINT,
        rpm_limit BIGINT,
        blocked BOOLEAN,
    
        -- Budget configuration
        max_budget DOUBLE PRECISION,
        budget_duration TEXT,
        budget_reset_at TIMESTAMP(3) WITHOUT TIME ZONE,
    
        -- Spend tracking
        model_spend JSONB NOT NULL DEFAULT '{}',
        model_max_budget JSONB NOT NULL DEFAULT '{}',
    
        -- Related entities
        budget_id TEXT,
        object_permission_id TEXT,
    
        -- Original timestamps from key creation/updates
        created_at TIMESTAMP(3) WITHOUT TIME ZONE,
        created_by TEXT,
        updated_at TIMESTAMP(3) WITHOUT TIME ZONE,
        updated_by TEXT,
    
        -- Rotation tracking
        rotation_count INTEGER DEFAULT 0,
        auto_rotate BOOLEAN DEFAULT FALSE,
        rotation_interval TEXT,
        last_rotation_at TIMESTAMP(3) WITHOUT TIME ZONE,
        key_rotation_at TIMESTAMP(3) WITHOUT TIME ZONE,
    
        -- Deletion metadata
        deleted_at TIMESTAMP(3) WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        deleted_by TEXT,
        deleted_by_api_key TEXT,
        litellm_changed_by TEXT
    );
    
    -- Create indexes for DeletedVerificationToken
    CREATE INDEX idx_deleted_token_token ON "LiteLLM_DeletedVerificationToken"(token);
    CREATE INDEX idx_deleted_token_deleted_at ON "LiteLLM_DeletedVerificationToken"(deleted_at);
    CREATE INDEX idx_deleted_token_user_id ON "LiteLLM_DeletedVerificationToken"(user_id);
    CREATE INDEX idx_deleted_token_team_id ON "LiteLLM_DeletedVerificationToken"(team_id);
    CREATE INDEX idx_deleted_token_organization_id ON "LiteLLM_DeletedVerificationToken"(organization_id);
    CREATE INDEX idx_deleted_token_key_alias ON "LiteLLM_DeletedVerificationToken"(key_alias);
    CREATE INDEX idx_deleted_token_created_at ON "LiteLLM_DeletedVerificationToken"(created_at);
    
    -- Add comment to table
    COMMENT ON TABLE "LiteLLM_DeletedVerificationToken" IS 'Audit table for deleted API keys - preserves spend and key information for historical tracking and compliance';
    
    -- ============================================================================
    -- Migration Complete
    -- ============================================================================
  add_performance_indexes_2025_01_21.sql: |-
    -- ============================================================================
    -- LiteLLM Performance Index Migration
    -- ============================================================================
    -- Purpose: Add critical performance indexes to reduce sequential scans
    -- Date: 2025-01-21
    -- Author: Database Architect (Auto-generated)
    -- ============================================================================
    -- ISSUE: Tables with 100% sequential scan ratios causing slow queries
    -- - LiteLLM_CredentialsTable: 20,499 seq scans, 0 index scans
    -- - LiteLLM_MCPServerTable: 20,380 seq scans, 0 index scans
    -- - LiteLLM_GuardrailsTable: 20,201 seq scans, 0 index scans
    -- - LiteLLM_PromptTable: 19,769 seq scans, 0 index scans
    -- - LiteLLM_BudgetTable: 1,438 seq scans, 0 index scans
    -- ============================================================================
    
    BEGIN;
    
    -- ----------------------------------------------------------------------------
    -- MCP Server Table Indexes
    -- ----------------------------------------------------------------------------
    -- Purpose: Speed up health check queries and server lookups by status/name
    -- Query Pattern: WHERE status = 'healthy' / ORDER BY server_name
    -- ----------------------------------------------------------------------------
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_status
        ON "LiteLLM_MCPServerTable"(status);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_name
        ON "LiteLLM_MCPServerTable"(server_name);
    
    -- Composite index for health check queries (status + last_health_check)
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_health_check
        ON "LiteLLM_MCPServerTable"(status, last_health_check DESC)
        WHERE last_health_check IS NOT NULL;
    
    -- ----------------------------------------------------------------------------
    -- Guardrails Table Indexes
    -- ----------------------------------------------------------------------------
    -- Purpose: Speed up time-based queries and sorting
    -- Query Pattern: ORDER BY created_at DESC / WHERE created_at > timestamp
    -- ----------------------------------------------------------------------------
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_guardrails_created
        ON "LiteLLM_GuardrailsTable"(created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Prompt Table Indexes
    -- ----------------------------------------------------------------------------
    -- Purpose: Speed up prompt version lookups
    -- Query Pattern: WHERE prompt_id = ? AND version = ?
    -- Note: Unique constraint already exists, this index optimizes the lookup
    -- ----------------------------------------------------------------------------
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_prompts_id_version
        ON "LiteLLM_PromptTable"(prompt_id, version DESC);
    
    -- Index for prompt_id-only queries (covering index with created_at)
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_prompts_id_created
        ON "LiteLLM_PromptTable"(prompt_id, created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Credentials Table Indexes
    -- ----------------------------------------------------------------------------
    -- Purpose: Speed up credential lookups by name
    -- Query Pattern: WHERE credential_name = ?
    -- Note: Unique constraint already exists, this ensures index usage
    -- ----------------------------------------------------------------------------
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_credential_name
        ON "LiteLLM_CredentialsTable"(credential_name);
    
    -- Index for time-based credential queries
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_credential_created
        ON "LiteLLM_CredentialsTable"(created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Budget Table Indexes
    -- ----------------------------------------------------------------------------
    -- Purpose: Speed up budget reset queries
    -- Query Pattern: WHERE budget_reset_at IS NOT NULL ORDER BY budget_reset_at
    -- Note: Partial index to exclude NULL values (smaller, faster)
    -- ----------------------------------------------------------------------------
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_budget_reset
        ON "LiteLLM_BudgetTable"(budget_reset_at)
        WHERE budget_reset_at IS NOT NULL;
    
    -- Index for budget lookups with duration
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_budget_duration
        ON "LiteLLM_BudgetTable"(budget_duration, budget_reset_at)
        WHERE budget_duration IS NOT NULL;
    
    -- ----------------------------------------------------------------------------
    -- Additional Performance Indexes (Based on Schema Analysis)
    -- ----------------------------------------------------------------------------
    
    -- Verification Token table - frequently queried for auth
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_token_user_id
        ON "LiteLLM_VerificationToken"(user_id)
        WHERE user_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_token_team_id
        ON "LiteLLM_VerificationToken"(team_id)
        WHERE team_id IS NOT NULL;
    
    -- Organization table - membership queries
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_organization_alias
        ON "LiteLLM_OrganizationTable"(organization_alias);
    
    -- User table - SSO and email lookups
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_sso_id
        ON "LiteLLM_UserTable"(sso_user_id)
        WHERE sso_user_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_email
        ON "LiteLLM_UserTable"(user_email)
        WHERE user_email IS NOT NULL;
    
    -- Team table - status and organization lookups
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_team_org_blocked
        ON "LiteLLM_TeamTable"(organization_id, blocked)
        WHERE organization_id IS NOT NULL;
    
    -- Spend Logs - time-based analytics queries
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_spend_logs_start_time
        ON "LiteLLM_SpendLogs"(startTime DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_spend_logs_model_time
        ON "LiteLLM_SpendLogs"(model, startTime DESC);
    
    -- Daily spend tables - date-based queries
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_user_spend_date
        ON "LiteLLM_DailyUserSpend"(date DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_org_spend_date
        ON "LiteLLM_DailyOrganizationSpend"(date DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_team_spend_date
        ON "LiteLLM_DailyTeamSpend"(date DESC);
    
    -- Proxy Model table - model name lookups
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_proxy_model_name
        ON "LiteLLM_ProxyModelTable"(model_name);
    
    -- Health Check table - recent status checks
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_health_check_status_checked
        ON "LiteLLM_HealthCheckTable"(status, checked_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Index Statistics Logging
    -- ----------------------------------------------------------------------------
    -- Record migration in audit log
    INSERT INTO "LiteLLM_AuditLog" (id, updated_at, changed_by, action, table_name, object_id, updated_values)
    VALUES (
        gen_random_uuid(),
        NOW(),
        'system',
        'create_indexes',
        'performance_migration',
        'add_performance_indexes_2025_01_21',
        '{"indexes_created": 23, "migration_type": "performance_optimization"}'::jsonb
    )
    ON CONFLICT (id) DO NOTHING;
    
    COMMIT;
    
    -- ============================================================================
    -- Expected Impact:
    -- - Reduced sequential scans on MCP Server, Credentials, Guardrails, and Prompt tables
    -- - Faster health check queries (mcpservers by status)
    -- - Improved prompt version lookups
    -- - Optimized budget reset queries
    -- - Better performance on authentication and organization queries
    -- ============================================================================
    -- Notes:
    -- - Used CONCURRENTLY to avoid table locks in production
    -- - Partial indexes used where appropriate to reduce index size
    -- - Composite indexes added for common query patterns
    -- - Descending indexes used for time-based queries (ORDER BY ... DESC)
    -- ============================================================================
  add_performance_indexes_2025_01_21_no_txn.sql: |-
    -- ============================================================================
    -- LiteLLM Performance Index Migration (Non-Transactional)
    -- ============================================================================
    -- Purpose: Add critical performance indexes to reduce sequential scans
    -- Date: 2025-01-21
    -- Author: Database Architect (Auto-generated)
    -- ============================================================================
    -- NOTE: CREATE INDEX CONCURRENTLY cannot run inside a transaction
    -- Each index is created individually to allow for concurrent builds
    -- ============================================================================
    
    -- ----------------------------------------------------------------------------
    -- MCP Server Table Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_status
        ON "LiteLLM_MCPServerTable"(status);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_name
        ON "LiteLLM_MCPServerTable"(server_name);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_mcp_server_health_check
        ON "LiteLLM_MCPServerTable"(status, last_health_check DESC)
        WHERE last_health_check IS NOT NULL;
    
    -- ----------------------------------------------------------------------------
    -- Guardrails Table Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_guardrails_created
        ON "LiteLLM_GuardrailsTable"(created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Prompt Table Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_prompts_id_version
        ON "LiteLLM_PromptTable"(prompt_id, version DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_prompts_id_created
        ON "LiteLLM_PromptTable"(prompt_id, created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Credentials Table Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_credential_name
        ON "LiteLLM_CredentialsTable"(credential_name);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_credential_created
        ON "LiteLLM_CredentialsTable"(created_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Budget Table Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_budget_reset
        ON "LiteLLM_BudgetTable"(budget_reset_at)
        WHERE budget_reset_at IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_budget_duration
        ON "LiteLLM_BudgetTable"(budget_duration, budget_reset_at)
        WHERE budget_duration IS NOT NULL;
    
    -- ----------------------------------------------------------------------------
    -- Additional Performance Indexes
    -- ----------------------------------------------------------------------------
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_token_user_id
        ON "LiteLLM_VerificationToken"(user_id)
        WHERE user_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_token_team_id
        ON "LiteLLM_VerificationToken"(team_id)
        WHERE team_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_organization_alias
        ON "LiteLLM_OrganizationTable"(organization_alias);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_sso_id
        ON "LiteLLM_UserTable"(sso_user_id)
        WHERE sso_user_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_email
        ON "LiteLLM_UserTable"(user_email)
        WHERE user_email IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_team_org_blocked
        ON "LiteLLM_TeamTable"(organization_id, blocked)
        WHERE organization_id IS NOT NULL;
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_spend_logs_start_time
        ON "LiteLLM_SpendLogs"(startTime DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_spend_logs_model_time
        ON "LiteLLM_SpendLogs"(model, startTime DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_user_spend_date
        ON "LiteLLM_DailyUserSpend"(date DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_org_spend_date
        ON "LiteLLM_DailyOrganizationSpend"(date DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_daily_team_spend_date
        ON "LiteLLM_DailyTeamSpend"(date DESC);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_proxy_model_name
        ON "LiteLLM_ProxyModelTable"(model_name);
    
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_health_check_status_checked
        ON "LiteLLM_HealthCheckTable"(status, checked_at DESC);
    
    -- ----------------------------------------------------------------------------
    -- Index Statistics Logging (Transaction-safe)
    -- ----------------------------------------------------------------------------
    
    BEGIN;
    
    INSERT INTO "LiteLLM_AuditLog" (id, updated_at, changed_by, action, table_name, object_id, updated_values)
    VALUES (
        gen_random_uuid(),
        NOW(),
        'system',
        'create_indexes',
        'performance_migration',
        'add_performance_indexes_2025_01_21',
        '{"indexes_created": 23, "migration_type": "performance_optimization"}'::jsonb
    )
    ON CONFLICT (id) DO NOTHING;
    
    COMMIT;
    
    -- ============================================================================
    -- Migration Complete
    -- ============================================================================
  rollback_performance_indexes_2025_01_21.sql: |-
    -- ============================================================================
    -- LiteLLM Performance Index Rollback Migration
    -- ============================================================================
    -- Purpose: Rollback performance indexes if issues occur
    -- Date: 2025-01-21
    -- Author: Database Architect (Auto-generated)
    -- Related Migration: add_performance_indexes_2025_01_21.sql
    -- ============================================================================
    -- WARNING: Only run this if the performance indexes cause issues
    -- These indexes are designed to improve query performance
    -- ============================================================================
    
    BEGIN;
    
    -- ----------------------------------------------------------------------------
    -- MCP Server Table Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_mcp_server_status;
    DROP INDEX CONCURRENTLY IF EXISTS idx_mcp_server_name;
    DROP INDEX CONCURRENTLY IF EXISTS idx_mcp_server_health_check;
    
    -- ----------------------------------------------------------------------------
    -- Guardrails Table Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_guardrails_created;
    
    -- ----------------------------------------------------------------------------
    -- Prompt Table Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_prompts_id_version;
    DROP INDEX CONCURRENTLY IF EXISTS idx_prompts_id_created;
    
    -- ----------------------------------------------------------------------------
    -- Credentials Table Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_credential_name;
    DROP INDEX CONCURRENTLY IF EXISTS idx_credential_created;
    
    -- ----------------------------------------------------------------------------
    -- Budget Table Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_budget_reset;
    DROP INDEX CONCURRENTLY IF EXISTS idx_budget_duration;
    
    -- ----------------------------------------------------------------------------
    -- Additional Performance Indexes
    -- ----------------------------------------------------------------------------
    DROP INDEX CONCURRENTLY IF EXISTS idx_verification_token_user_id;
    DROP INDEX CONCURRENTLY IF EXISTS idx_verification_token_team_id;
    DROP INDEX CONCURRENTLY IF EXISTS idx_organization_alias;
    DROP INDEX CONCURRENTLY IF EXISTS idx_user_sso_id;
    DROP INDEX CONCURRENTLY IF EXISTS idx_user_email;
    DROP INDEX CONCURRENTLY IF EXISTS idx_team_org_blocked;
    DROP INDEX CONCURRENTLY IF EXISTS idx_spend_logs_start_time;
    DROP INDEX CONCURRENTLY IF EXISTS idx_spend_logs_model_time;
    DROP INDEX CONCURRENTLY IF EXISTS idx_daily_user_spend_date;
    DROP INDEX CONCURRENTLY IF EXISTS idx_daily_org_spend_date;
    DROP INDEX CONCURRENTLY IF EXISTS idx_daily_team_spend_date;
    DROP INDEX CONCURRENTLY IF EXISTS idx_proxy_model_name;
    DROP INDEX CONCURRENTLY IF EXISTS idx_health_check_status_checked;
    
    -- ----------------------------------------------------------------------------
    -- Rollback Audit Log Entry
    -- ----------------------------------------------------------------------------
    INSERT INTO "LiteLLM_AuditLog" (id, updated_at, changed_by, action, table_name, object_id, updated_values)
    VALUES (
        gen_random_uuid(),
        NOW(),
        'system',
        'rollback_indexes',
        'performance_migration',
        'rollback_performance_indexes_2025_01_21',
        '{"indexes_dropped": 23, "migration_type": "performance_rollback"}'::jsonb
    )
    ON CONFLICT (id) DO NOTHING;
    
    COMMIT;
    
    -- ============================================================================
    -- Rollback Complete
    -- ============================================================================
    -- All performance indexes from the 2025-01-21 migration have been removed
    -- Sequential scan ratios will return to previous levels
    -- ============================================================================
