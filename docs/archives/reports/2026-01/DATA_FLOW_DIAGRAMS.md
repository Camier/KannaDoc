# RAG System Data Flow Diagrams (Visual)

## Overview

This document provides visual ASCII diagrams for the complete data flow through the Layra RAG system, focusing on bottlenecks, consistency boundaries, and error propagation paths.

---

## 1. Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAYRA RAG SYSTEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Frontend â”‚    â”‚ Frontend â”‚    â”‚ Frontend â”‚    â”‚ Frontend â”‚         â”‚
â”‚  â”‚  Upload  â”‚    â”‚  Query   â”‚    â”‚ Workflow â”‚    â”‚  Admin   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                â”‚                â”‚                â”‚               â”‚
â”‚        â–¼                â–¼                â–¼                â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     FASTAPI BACKEND                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Chat API    â”‚  â”‚ Workflow    â”‚  â”‚ Kafka Producer         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (chat.py)   â”‚  â”‚ API         â”‚  â”‚ Manager                â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚         â”‚                 â”‚                     â”‚                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚              BUSINESS LOGIC LAYER                  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ RAG Utilsâ”‚  â”‚ Workflow â”‚  â”‚ MCP Tools        â”‚  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”‚          â”‚  â”‚ Engine   â”‚  â”‚                  â”‚  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚       â”‚             â”‚                               â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  File Conversion      â”‚  â”‚ Code Sandbox      â”‚  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  (PDFâ†’Images)         â”‚  â”‚ (Docker)          â”‚  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                     â”‚
â”‚                                   â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    SERVICE LAYER                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Embedding    â”‚  â”‚ LLM Provider â”‚  â”‚ Circuit Breaker      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ Service      â”‚  â”‚ Client       â”‚  â”‚                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (ColQwen)    â”‚  â”‚ (Multi-API)  â”‚  â”‚                      â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                  â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚
             â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MESSAGE QUEUE                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    KAFKA CLUSTER                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚  â”‚ task_generation   â”‚    â”‚ task_generation   â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚ (main topic)      â”‚    â”‚ _dlq (DLQ)        â”‚                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     STORAGE LAYER                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   MinIO      â”‚  â”‚   Milvus     â”‚  â”‚   MongoDB    â”‚  â”‚   Redis    â”‚ â”‚
â”‚  â”‚  (Files)     â”‚  â”‚  (Vectors)   â”‚  â”‚  (Metadata)  â”‚  â”‚  (State)   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚            â”‚ â”‚
â”‚  â”‚  - Original  â”‚  â”‚  - ColQwen   â”‚  â”‚  - Users     â”‚  â”‚  - Tasks   â”‚ â”‚
â”‚  â”‚  - Images    â”‚  â”‚    vectors   â”‚  â”‚  - Files     â”‚  â”‚  - State   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  - HNSW idx  â”‚  â”‚  - Convers.  â”‚  â”‚  - Events  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Upload Flow - Detailed Sequence

```
TIMELINE: File Upload (User â†’ Storage)

User API           FastAPI            MinIO           Kafka           Consumer
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚ POST /upload    â”‚                  â”‚               â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Create KB ID     â”‚               â”‚                â”‚
  â”‚                 â”‚ Init Redis task  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Parallel upload  â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚ Store files   â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚                â”‚
  â”‚                 â”‚ file_meta        â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Send messages    â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚ Enqueue        â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚ Response        â”‚                  â”‚               â”‚                â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚               â”‚                â”‚
  â”‚ task_id         â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚    Consumer    â”‚
  â”‚                 â”‚                  â”‚               â”‚    receives    â”‚
  â”‚                 â”‚                  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚    Validate    â”‚
  â”‚                 â”‚                  â”‚               â”‚    idempotency â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚ Download file â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚ file_content     â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Convert to images               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚ images_buffer    â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚ Generate embed â”‚
  â”‚                 â”‚                  â”‚               â”‚ (ColQwen)      â”‚
  â”‚                 â”‚                  â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
  â”‚                 â”‚                  â”‚               â”‚        â”‚       â”‚
  â”‚                 â”‚                  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
  â”‚                 â”‚                  â”‚               â”‚ embeddings     â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Insert vectors   â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚ Store vectors â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Upload images    â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚ Store images  â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚                â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Save metadata    â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Update progress  â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚               â”‚                â”‚
  â”‚                 â”‚ Commit offset    â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚

BOTTLENECKS: ğŸ”´
  1. Parallel MinIO upload (blocks until all files uploaded)
  2. Synchronous PDF conversion (blocks event loop, up to 10min)
  3. Sequential embedding batches (no pipelining)
```

---

## 3. Query Flow - Detailed Sequence

```
TIMELINE: User Query (Search â†’ LLM)

User API           FastAPI            Redis          Milvus          Embedding
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚ POST query      â”‚                  â”‚              â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ Load conversationâ”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚
  â”‚                 â”‚ history          â”‚              â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ Replace images   â”‚              â”‚                â”‚
  â”‚                 â”‚ (MinIOâ†’base64)   â”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ Generate query   â”‚              â”‚                â”‚
  â”‚                 â”‚ embedding        â”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚ Query vectors  â”‚
  â”‚                 â”‚                  â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ Vector search    â”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚ MaxSim search  â”‚
  â”‚                 â”‚                  â”‚              â”‚ (CPU bottleneck)â”‚
  â”‚                 â”‚                  â”‚ Results      â”‚                â”‚
  â”‚                 â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚                 â”‚ results          â”‚              â”‚                â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ Build context    â”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚ LLM call         â”‚              â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚
  â”‚ SSE Stream      â”‚                  â”‚              â”‚                â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚              â”‚                â”‚
  â”‚ chunks          â”‚                  â”‚              â”‚                â”‚
  â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                  â”‚              â”‚                â”‚
  â”‚                 â”‚                  â”‚              â”‚                â”‚

BOTTLENECKS: ğŸ”´
  1. Image replacement (synchronous MinIO download)
  2. MaxSim reranking in Python (CPU-bound)
  3. Sequential vector fetch (pagination)
```

---

## 4. Workflow Flow - Detailed Sequence

```
TIMELINE: Workflow Execution

Frontend          FastAPI             Kafka           Engine          Sandbox
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚ Trigger         â”‚                   â”‚               â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚ Send message      â”‚               â”‚                â”‚
  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Enqueue       â”‚                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Consumer receives               â”‚
  â”‚                 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Initialize    â”‚                â”‚
  â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚    Start sandbox               â”‚
  â”‚                 â”‚                   â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                 â”‚                   â”‚               â”‚ Docker start   â”‚
  â”‚                 â”‚                   â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Execute graph â”‚                â”‚
  â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚                 â”‚                   â”‚    â”‚ Loop over nodes:       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚                       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚ CODE NODE:            â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Security scan     â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Execute code      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   â”‚ container.exec_runâ”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Parse output      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚                       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚ VLM NODE:            â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - MCP tool selectionâ”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - LLM call          â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Stream response   â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Extract JSON      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚                       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚ CONDITION NODE:      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Safe eval         â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Route children     â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚                       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚ LOOP NODE:           â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Check condition   â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Execute body      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚   - Update index      â”‚  â”‚
  â”‚                 â”‚                   â”‚    â”‚                       â”‚  â”‚
  â”‚                 â”‚                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Send events   â”‚                â”‚
  â”‚                 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚ SSE Events      â”‚                   â”‚               â”‚                â”‚
  â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                   â”‚               â”‚                â”‚
  â”‚ status/chunks   â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Commit state  â”‚                â”‚
  â”‚                 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                 â”‚                   â”‚               â”‚                â”‚
  â”‚                 â”‚                   â”‚ Stop sandbox  â”‚                â”‚
  â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                 â”‚                   â”‚               â”‚ Docker stop    â”‚

BOTTLENECKS: ğŸ”´
  1. Sequential node execution (no parallelism)
  2. Synchronous Docker exec_run (blocking)
  3. In-memory context accumulation
```

---

## 5. Error Propagation Flow

```
ERROR PROPAGATION: File Processing Failure

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     ERROR OCCURS                           â”‚
     â”‚                  (e.g., Milvus insert fails)              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  ERROR CLASSIFICATION                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                             â”‚
     â”‚  Check error message for keywords:                         â”‚
     â”‚  - "embedding", "memory", "oom", "cuda", "gpu"             â”‚
     â”‚                                                             â”‚
     â”‚  IF keyword found â†’ RECOVERABLE                            â”‚
     â”‚  ELSE â†’ NON-RECOVERABLE                                   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                               â”‚
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RECOVERABLE  â”‚               â”‚NON-RECOVERABLEâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                               â”‚
            â”‚                               â”‚
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   NO CLEANUP  â”‚               â”‚    CLEANUP    â”‚
    â”‚               â”‚               â”‚               â”‚
    â”‚ - Keep Milvus â”‚               â”‚ 1. Delete     â”‚
    â”‚   vectors     â”‚               â”‚    Milvus     â”‚
    â”‚ - Keep Mongo  â”‚               â”‚    vectors    â”‚
    â”‚   metadata    â”‚               â”‚               â”‚
    â”‚               â”‚               â”‚ 2. Remove     â”‚
    â”‚ Retry after   â”‚               â”‚    from KB    â”‚
    â”‚ backoff       â”‚               â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ 3. Delete     â”‚
            â”‚                       â”‚    file       â”‚
            â”‚                       â”‚    record    â”‚
            â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              UPDATE REDIS TASK STATUS                      â”‚
     â”‚                                                              â”‚
     â”‚  HSET task:{task_id}                                       â”‚
     â”‚    status = "failed"                                       â”‚
     â”‚    message = "File processing failed: {error}"             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  RAISE EXCEPTION                           â”‚
     â”‚                                                              â”‚
     â”‚  Kafka Consumer will:                                      â”‚
     â”‚  - NOT commit offset                                       â”‚
     â”‚  - Retry with exponential backoff (max 3x)                 â”‚
     â”‚  - Send to DLQ if all retries fail                         â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DLQ FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  task_generation_dlq                                        â”‚
â”‚                                                              â”‚
â”‚  {                                                           â”‚
â”‚    original_topic: "task_generation",                       â”‚
â”‚    error: "...",                                            â”‚
â”‚    error_type: "MilvusException",                           â”‚
â”‚    payload: {original message},                             â”‚
â”‚    timestamp: "2026-01-28...",                              â”‚
â”‚    retry_count: 3                                           â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  Requires manual inspection and reprocessing                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Data Consistency Boundaries

```
CONSISTENCY BOUNDARIES: File Upload

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  TRANSACTION 1: MinIO Upload                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State: ATOMIC (within MinIO)                                      â”‚ â”‚
â”‚  â”‚  Consistency: IMMEDIATE                                            â”‚ â”‚
â”‚  â”‚  Failure Mode: No file stored                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  TRANSACTION 2: Kafka Message                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State: FIRE-AND-FORGET                                            â”‚ â”‚
â”‚  â”‚  Consistency: EVENTUAL (consumer must process)                     â”‚ â”‚
â”‚  â”‚  Failure Mode: Message lost, orphaned MinIO file                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  TRANSACTION 3: Consumer Processing (Non-Atomic)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Step 1: Validate MinIO file (read)                                â”‚ â”‚
â”‚  â”‚  Step 2: Convert to images (CPU-intensive)                         â”‚ â”‚
â”‚  â”‚  Step 3: Generate embeddings (external service)                    â”‚ â”‚
â”‚  â”‚  Step 4: Insert to Milvus                                          â”‚ â”‚
â”‚  â”‚  Step 5: Upload images to MinIO                                    â”‚ â”‚
â”‚  â”‚  Step 6: Insert to MongoDB                                        â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  State: NO DISTRIBUTED TRANSACTION                                 â”‚ â”‚
â”‚  â”‚  Consistency: EVENTUAL across services                             â”‚ â”‚
â”‚  â”‚  Failure Modes:                                                    â”‚ â”‚
â”‚  â”‚    - Step 4 fails â†’ Orphaned MinIO images                         â”‚ â”‚
â”‚  â”‚    - Step 5 fails â†’ Orphaned Milvus vectors                       â”‚ â”‚
â”‚  â”‚    - Step 6 fails â†’ Inconsistent metadata                         â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  Cleanup: Best-effort deletion on failure (no rollback guarantee)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  TRANSACTION 4: Redis Progress Update                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State: ATOMIC (within Redis)                                      â”‚ â”‚
â”‚  â”‚  Consistency: IMMEDIATE                                            â”‚ â”‚
â”‚  â”‚  Failure Mode: Stale progress shown to user                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  TRANSACTION 5: Kafka Offset Commit                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State: ATOMIC (within Kafka)                                      â”‚ â”‚
â”‚  â”‚  Consistency: IMMEDIATE                                            â”‚ â”‚
â”‚  â”‚  Failure Mode: Duplicate processing (idempotency key prevents)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ORPHAN DATA SCENARIOS:

  1. MinIO file exists, Milvus vectors missing
     â†’ User can see file, search returns no results
     â†’ Detection: Query Milvus for file_id, check if empty

  2. Milvus vectors exist, MongoDB metadata missing
     â†’ Search returns results, no file metadata
     â†’ Detection: Query Mongo by file_id from Milvus results

  3. MongoDB metadata exists, MinIO file missing
     â†’ File appears in list, download fails
     â†’ Detection: Scheduled job to validate MinIO URLs

CONSISTENCY CHECKS:
  - No foreign key constraints across systems
  - No distributed transaction manager
  - No compensating transaction coordinator
  - Best-effort cleanup only
```

---

## 7. Bottleneck Heatmap

```
BOTTLENECK SEVERITY MATRIX

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PERFORMANCE IMPACT                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ High      â”‚  ğŸ”´ PDF Conversion (10min/block)                       â”‚ â”‚
â”‚  â”‚ Impact    â”‚  ğŸ”´ Sequential Embedding (batch-by-batch)             â”‚ â”‚
â”‚  â”‚           â”‚  ğŸ”´ MaxSim Reranking (CPU-bound)                      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Medium    â”‚  ğŸŸ¡ Docker Exec (per node)                            â”‚ â”‚
â”‚  â”‚ Impact    â”‚  ğŸŸ¡ Image Replacement (synchronous download)          â”‚ â”‚
â”‚  â”‚           â”‚  ğŸŸ¡ Context Cleanup (in-execution)                    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Low       â”‚  ğŸŸ¢ MinIO Upload (parallelized)                       â”‚ â”‚
â”‚  â”‚ Impact    â”‚  ğŸŸ¢ Milvus Search (HNSW indexed)                      â”‚ â”‚
â”‚  â”‚           â”‚  ğŸŸ¢ Redis Operations (in-memory)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  FREQUENCY:                                                            â”‚
â”‚  - Per-Request: Image replacement, embedding, search                   â”‚
â”‚  - Per-File: PDF conversion, MinIO upload                             â”‚
â”‚  - Per-Workflow: Node execution, sandbox operations                    â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTIMIZATION PRIORITY:

1. ğŸ”´ CRITICAL (Do first)
   - Parallelize PDF conversion with multiprocessing
   - Pipeline embedding batches (overlap I/O)
   - Move MaxSim to GPU (embedding service)

2. ğŸŸ¡ HIGH (Do next)
   - Cache converted images in Redis
   - Implement parallel node execution in workflows
   - Add Docker container pooling

3. ğŸŸ¢ MEDIUM (Do later)
   - Optimize context cleanup (background thread)
   - Add streaming progress for uploads
   - Implement connection pooling for external APIs
```

---

## 8. State Management Flow

```
WORKFLOW STATE LIFECYCLE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  STATE CREATED                     STATE TRANSITIONS                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ workflow:{task_id}  â”‚            â”‚                               â”‚  â”‚
â”‚  â”‚   status: pending   â”‚            â”‚  pending â†’ running            â”‚  â”‚
â”‚  â”‚   nodes: {}         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  running â†’ completed          â”‚  â”‚
â”‚  â”‚   edges: []         â”‚            â”‚  running â†’ failed             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  running â†’ pause              â”‚  â”‚
â”‚                                    â”‚  running â†’ vlm_input           â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  pause â†’ running (resume)     â”‚  â”‚
â”‚  â”‚ workflow:{task_id}  â”‚            â”‚  vlm_input â†’ running          â”‚  â”‚
â”‚  â”‚   :nodes           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  running â†’ canceled           â”‚  â”‚
â”‚  â”‚   node_id: 0/1     â”‚            â”‚                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  CHECKPOINT SYSTEM                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  workflow:{task_id}:state (Redis, TTL=3600s)                    â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  {                                                               â”‚   â”‚
â”‚  â”‚    global_variables: {...},      // User-defined variables      â”‚   â”‚
â”‚  â”‚    execution_status: {...},      // Node completion map         â”‚   â”‚
â”‚  â”‚    execution_stack: [nids],     // Pending nodes               â”‚   â”‚
â”‚  â”‚    loop_index: {...},           // Loop counters               â”‚   â”‚
â”‚  â”‚    context: {...},              // Node outputs                â”‚   â”‚
â”‚  â”‚    skip_nodes: [...],           // Conditional skips           â”‚   â”‚
â”‚  â”‚    nodes: [...],                // Graph definition            â”‚   â”‚
â”‚  â”‚    edges: [...]                 // Graph definition            â”‚   â”‚
â”‚  â”‚  }                                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                  â”‚
â”‚                                    â”‚ TRIGGERS                         â”‚
â”‚                                    â”œâ”€ before_node (for rollback)      â”‚
â”‚                                    â”œâ”€ after_node (for recovery)       â”‚
â”‚                                    â”œâ”€ loop_complete (iteration)       â”‚
â”‚                                    â””â”€ gate (conditional routing)      â”‚
â”‚                                    â”‚                                  â”‚
â”‚                                    â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ROLLBACK ON ERROR                                             â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  1. Detect exception in execute_node()                          â”‚   â”‚
â”‚  â”‚  2. Call checkpoint_manager.rollback_to_checkpoint()            â”‚   â”‚
â”‚  â”‚  3. Restore: global_variables, execution_status, context        â”‚   â”‚
â”‚  â”‚  4. Rebuild execution_stack from checkpoint                     â”‚   â”‚
â”‚  â”‚  5. Continue from checkpoint node                               â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  LIMITATIONS:                                                    â”‚   â”‚
â”‚  â”‚  - Sandbox container state NOT restored                         â”‚   â”‚
â”‚  â”‚  - External API calls NOT replayed                              â”‚   â”‚
â”‚  â”‚  - LLM token usage NOT recovered                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  EVENT STREAM (Real-time Progress)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  workflow:events:{task_id} (Redis Stream, XTRIM)                â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Event Types:                                                    â”‚   â”‚
â”‚  â”‚  - {type: "workflow", status: "running"}                        â”‚   â”‚
â”‚  â”‚  - {type: "node", node: "node_1", status: "running"}            â”‚   â”‚
â”‚  â”‚  - {type: "ai_chunk", data: "{text chunk}"}                     â”‚   â”‚
â”‚  â”‚  - {type: "workflow", status: "completed", result: "{...}"}     â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Frontend: XRANGE workflow:events:{task_id} + (stream via SSE)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STATE EXPIRATION RISK:
- TTL: 3600 seconds (1 hour)
- Problem: User pauses workflow, doesn't resume within 1 hour
- Result: State lost, "Workflow expired!" error
- Mitigation: None currently (archival to MongoDB recommended)
```

---

## 9. Circuit Breaker Flow

```
CIRCUIT BREAKER: LLM Service Protection

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  STATES                                                                â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     failure_threshold=5, timeout=60s                â”‚
â”‚  â”‚   CLOSED   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ (Normal)   â”‚                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
â”‚        â”‚                                                           â”‚  â”‚
â”‚        â”‚ Request                                                   â”‚  â”‚
â”‚        â”‚                                                           â”‚  â”‚
â”‚        â–¼                                                           â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     failure_count >= 5                            â”‚  â”‚
â”‚  â”‚   CLOSED   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  â”‚
â”‚  â”‚ (Executing)â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
â”‚        â”‚                                                           â”‚  â”‚
â”‚        â”‚ Success                                                   â”‚  â”‚
â”‚        â”‚ failure_count = 0                                        â”‚  â”‚
â”‚        â”‚                                                           â”‚  â”‚
â”‚        â–¼                                                           â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚  â”‚
â”‚  â”‚   CLOSED   â”‚                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
â”‚                                                                    â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     timeout=60s elapsed                           â”‚  â”‚
â”‚  â”‚    OPEN    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ (Failing)  â”‚                                                       â”‚
â”‚  â”‚ Fail fast  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
â”‚                                                                    â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚  â”‚
â”‚  â”‚ HALF_OPEN  â”‚                                                    â”‚  â”‚
â”‚  â”‚ (Testing)  â”‚â”€â”€â”€< next request >â”€â”€â”€< success? â”€â”€> CLOSED        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
â”‚        â”‚                                                           â”‚  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ failure? â”€â”€> OPEN                              â”‚  â”‚
â”‚                                                                    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IMPLEMENTATION:

@app.post("/chat")
@llm_service_circuit  # Decorator applies circuit breaker
async def chat_endpoint(...):
    # LLM call protected by circuit breaker
    return await llm_service.chat(...)

CONFIG:
- failure_threshold: 5 failures
- recovery_timeout: 60 seconds
- expected_exception: Exception (catches all)

BEHAVIOR:
- CLOSED: Normal operation, requests pass through
- OPEN: Fail fast, raise CircuitBreakerOpenException immediately
- HALF_OPEN: Allow one request to test recovery

MONITORING:
- Export state to Prometheus
- Alert on circuit open
- Track failure rate

LIMITATIONS:
- No per-model isolation (all models share circuit)
- No adaptive thresholds (fixed at 5 failures)
- No manual reset (must wait for timeout)
```

---

## 10. Quick Reference

### File Paths

```
Upload Flow:
  /backend/app/api/endpoints/chat.py (upload_multiple_files)
  /backend/app/rag/convert_file.py (save_file_to_minio)
  /backend/app/rag/utils.py (process_file)
  /backend/app/utils/kafka_consumer.py (KafkaConsumerManager)

Query Flow:
  /backend/app/rag/utils.py (replace_image_content)
  /backend/app/rag/get_embedding.py (get_embeddings_from_httpx)
  /backend/app/db/milvus.py (MilvusManager.search)

Workflow Flow:
  /backend/app/workflow/workflow_engine.py (WorkflowEngine)
  /backend/app/workflow/sandbox.py (CodeSandbox)
  /backend/app/workflow/components/checkpoint_manager.py

Error Handling:
  /backend/app/core/circuit_breaker.py (embedding_service_circuit)
  /backend/app/utils/kafka_consumer.py (DLQ handling)
```

### Key Constants

```
BATCH_SIZES:
  EMBED_BATCH_SIZE = 16 (embeddings per batch)

TIMEOUTS:
  pdf_conversion_timeout = 600 (seconds)
  embedding_service_timeout = 1200 (seconds)
  docker_exec_timeout = 3600 (seconds)

LIMITS:
  MAX_CONCURRENT = 10 (Kafka consumer tasks)
  MAX_CONTEXT_ENTRIES = 1000 (workflow context)
  MAX_CONTEXT_SIZE = 50 (per node)
  LOOP_LIMITS = {"condition": 1000} (max loop iterations)

TTL:
  IDEMPOTENCY_TTL = 86400 (24 hours, Redis)
  WORKFLOW_STATE_TTL = 3600 (1 hour, Redis)
```

### Bottleneck Locations

```
1. PDF Conversion: /backend/app/rag/convert_file.py:133-143
2. Embedding Batching: /backend/app/rag/utils.py:110-151
3. Image Replacement: /backend/app/rag/utils.py:260-290
4. MaxSim Reranking: /backend/app/db/milvus.py:236-243
5. Node Execution: /backend/app/workflow/workflow_engine.py:577-583
6. Docker Exec: /backend/app/workflow/sandbox.py:223-239
```

---

**Document Version**: 1.0
**Last Updated**: 2026-01-28
**Companion**: DATA_FLOW_ANALYSIS.md (detailed textual analysis)
